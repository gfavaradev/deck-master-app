name: Release to Google Play

on:
  push:
    branches:
      - main
  workflow_dispatch: # permette di avviare manualmente dalla UI di GitHub

jobs:
  build-and-deploy:
    name: Build & Deploy Android
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout del codice
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 3. Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # 4. Installa dipendenze
      - name: Flutter pub get
        run: flutter pub get

      # 5. Ricrea google-services.json dal secret
      - name: Restore google-services.json
        run: echo "${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}" | base64 --decode > android/app/google-services.json

      # 6. Ricrea il keystore dal secret
      - name: Restore keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/deck_master_keystore.jks

      # 7. Ricrea key.properties dal secret
      - name: Restore key.properties
        run: |
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=../deck_master_keystore.jks
          EOF

      # 8. Ricrea il file .env dal secret (se presente)
      - name: Restore .env
        if: ${{ secrets.ENV_FILE_BASE64 != '' }}
        run: echo "${{ secrets.ENV_FILE_BASE64 }}" | base64 --decode > .env

      # 9. Build del bundle con versionCode automatico (= numero del run GitHub)
      - name: Build App Bundle
        run: flutter build appbundle --release --build-number=${{ github.run_number }}

      # 10. Upload su Google Play (canale interno)
      - name: Upload to Google Play (internal track)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
          packageName: com.giuseppe.deckmaster
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: internal
          status: completed
